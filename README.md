# sa_portfolio_public
Коллекция артефактов по бизнес- и системному анализу: ТЗ, диаграммы, прототипы и SQL-скрипты. Примеры выявления требований, документирования и моделирования проектов.
# Техническое задание: Интеграция системы управления задачами с Юридической системой

## Общая информация
- **Заказчик:** Крупный финансовый институт (обезличено)
- **Интегрируемые системы:** 
  - Система управления задачами (SRC) → Юридическая система (DST)
- **Дата:** 2025 год

## Бизнес-контекст
Автоматизация процессов обработки входящих судебных исков в юридическом департаменте. Ручной ввод данных занимал значительное время и мог приводить к ошибкам. Интеграция позволила исключить дублирование работы и ускорить процесс регистрации исков.

## Пользовательские истории

### US-01: Автоматическое создание карточки иска в Юридической системе
**Как:** Пользователь модуля мониторинга судебных дел  
**Я хочу:** Чтобы при создании задачи в системе управления задачами автоматически создавалась карточка в Юридической системе  
**Цель:** Исключить ручной ввод дублирующих данных и ускорить процесс создания карточек.

**Критерии приемки:**
- Карточка создается в модуле Юридической системы при создании новой задачи в системе управления задачами.
- Система проверяет, что карточка не была создана ранее (по полю внешнего идентификатора).

### US-02: Автоматическое заполнение полей карточки
**Как:** Сотрудник юридического департамента  
**Я хочу:** Чтобы данные из системы задач корректно маппились в соответствующие поля Юридической системы  
**Цель:** Исключить ошибки ручного переноса информации.

**Критерии приемки:**
- Все поля из системы задач, указанные в маппинге, переносятся в Юридическую систему без ошибок.
- Для полей, требующих преобразования, данные корректно форматируются.
- Если поле в системе задач пустое, соответствующее поле в Юридической системе остается пустым или заполняется значением по умолчанию.

### Схема процесса:

<img width="1188" height="2060" alt="sequence" src="https://github.com/user-attachments/assets/3db67f52-7eac-4ff4-afe5-5e3a28b6edc1" />

### Основные этапы интеграции:

#### 1. Получение данных из системы задач
- **Метод:** GET /forms/{form-id}/register
- **Параметры:** Фильтрация по дате создания, сортировка по ID
- **Периодичность:** Ежедневная синхронизация

#### 2. Обработка и валидация данных
- Проверка на дубликаты
- Преобразование форматов данных
- Валидация обязательных полей

#### 3. Создание карточек в Юридической системе
- INSERT в основные таблицы БД
- Обработка связей между сущностями
- Логирование результатов

## Маппинг данных (пример для одной формы)

### Форма: "Входящие иски"

| Поле в системе задач | Поле в Юридической системе | Преобразование |
|---------------------|---------------------------|----------------|
| Истец               | PERSON.F + PERSON.I + PERSON.O | Конкатенация ФИО |
| ИНН                 | PERSON.INN                | Прямое отображение |
| Вид спора           | LAW_ACT_DEBT.TYP          | Справочное значение |
| Сумма требований    | LAW_ACT_DEBT.DAMAGES      | Прямое отображение |

*Полная таблица маппинга содержит 20+ полей для каждой из 5 форм*

## Доработки в базе данных

### Новые поля в таблице law_act_debt:
- `saving_sum` - Сумма экономии банка
- `court_name` - Наименование суда (резервное)
- `typ_name` - Наименование вида заявления
- `user_result_name` - Наименование результата рассмотрения

## Бизнес-логика обработки

### Алгоритм дедупликации истцов:
1. При наличии ИНН - поиск по ИНН
2. При отсутствии ИНН - поиск по ФИО
3. При нахождении дублей - выбор записи с максимальным ID

### Обработка исключительных ситуаций:
- Отсутствие обязательных полей
- Несоответствие форматов данных
- Ошибки подключения к системам

## Нефункциональные требования

### Производительность:
- **Время обработки:** До 5 минут для 100+ задач
- **Периодичность:** Ежедневный запуск в 05:00
- **Окно обработки:** Задачи за последние 2 дня (компенсация сбоев)

### Надежность:
- Повторная обработка при сбоях
- Детальное логирование ошибок
- Уведомления о критических сбоях

### Безопасность:
- Аутентификация через API-ключи
- Валидация входных данных
- Ограничение прав доступа к БД


# SQL

-- Формирование списка на обзвон клиентов о предстоящих платежах
-- Назначение: Выборка клиентов для предупреждения о скорой оплате по траншу договора
-- Бизнес-логика: Проактивное информирование клиентов до наступления даты платежа
-- Особенности: Учет часовых поясов, календаря событий, размера задолженности
    
    select 
    p.id person_id, 
    d_main.id main_id, 
    d_part.id part_id,
    -- Основной долг: основной долг, просроченный основной долг, проценты и просроченные проценты
    d_main.basic_sum main_basic_sum, 
    d_main.exp_basic_sum main_exp_basic_sum,
    d_main.percent_sum main_percent_sum, 
    d_main.exp_percent_sum main_exp_percent_sum,
    -- Частичный долг (транш): аналогичные суммы по части долга
    d_part.basic_sum part_basic_sum, 
    d_part.exp_basic_sum part_exp_basic_sum,
    d_part.percent_sum part_percent_sum, 
    d_part.exp_percent_sum part_exp_percent_sum,
    -- Часовой пояс клиента для определения времени контакта
    nvl(p.person_gmt, 3) gmt, 
    -- Дата ближайшего платежа для приоритизации
    ps.dt payment_dt
    from debt d_part  -- Работаем с частями долгов (траншами)
    -- Подзапрос: Сумма предстоящих платежей по каждому долгу на ближайшие N дней
    join ( 
        select 
            ext_id, 
            sum(ps1.PAY_BASIC_SUM) sum_op  -- Общая сумма к оплате
        from corpcon.payment_schedule ps1
        join corpcon.debt d2 on d2.id = ps1.parent_id 
            and d2.main_part is null  -- Только части долгов (не основные)
            and nvl(ps1.PAY_BASIC_SUM, 0) > 0  -- Только платежи с основной суммой долга
            and ps1.dt between trunc(sysdate) and  -- Платежи начиная с сегодня
                trunc(sysdate) + (
                    select c.value from corpcon.const_value c 
                    where c.name = 'GROUP_PRC_DAYS'  -- Количество дней для планирования (из настроек)
                )
            -- Проверка, что долг относится к подходящим типам договора
            and exists (
                select 1 from corpcon.param_admin pa
                where pa.no_active = 0      
                    and pa.typ = 1          
                    and pa.debt_group = 1   
                    and pa.name_id = d2.name_id  -- Соответствие продукту
            )
        group by d2.ext_id  -- Группировка по внешнему ID долга
    ) op on op.ext_id = d_part.ext_id  -- Связь по внешнему идентификатору

    -- Присоединяем график платежей для определения дат
    join payment_schedule ps on d_part.id = ps.parent_id
    and nvl(ps.PAY_BASIC_SUM, 0) > 0  -- Только платежи с основной суммой долга
    and ps.dt between trunc(sysdate) and  -- В ближайшие N дней
       trunc(sysdate) + (select c.value from const_value c where c.name = 'GROUP_PRC_DAYS')

    -- Основной долг (для получения полной информации о клиенте)
    left join debt d_main on d_main.ext_id = d_part.ext_id
    and d_main.main_part = 1  -- Только основная часть долга

    -- Данные клиента
    left join person p on p.id = d_main.parent_id
    -- Информация о счете для проверки баланса
    left join account ac on ac.account_id = d_main.account

    where 
    -- Фильтр по источнику данных: договоры из системы SAE
    d_main.src = 'SAE'
    
    and d_main.name_id in (
        select name_id from corpcon.param_admin 
        where typ=1 and no_active=0 and debt_group=1
    )
    
    -- В части долга должна быть положительная сумма (основной долг + основной просроченный долг + просроченные проценты)
    and nvl(d_part.basic_sum, 0) + nvl(d_part.exp_basic_sum, 0) +
        nvl(d_part.exp_percent_sum, 0) > 0
    
    -- Баланс счета меньше суммы предстоящих платежей (признак необходимости действий)
    and (ac.balance < op.sum_op)
    
    -- Работаем только с частями долгов (не основными записями)
    and nvl(d_part.main_part, 0) = 0
    
    -- Основной долг не должен иметь просроченных сумм (взыскание по частям)
    and (nvl(d_main.exp_basic_sum,0)+nvl(d_main.exp_percent_sum_6,0)+
         nvl(d_main.exp_percent_sum_106,0)+nvl(d_main.due_sum,0)) <= 0
    
    -- Исключаем долги с специальной маркировкой (mark4=9 - кредитные каникулы)
    and nvl(d_main.mark4, 0) <> 9
    
    -- условие по календарю событий:
    -- Либо есть запланированное событие на сегодня для ответственного сотрудника
    -- Либо вообще нет запланированных событий для этого менеджера
    and (
        exists (
            select /*+index(ec)*/ null from events_calendar ec
            where ec.ext_id = d_main.ext_id
                and nvl(ec.block_flag, 0) = 0  -- Активное событие
                and d_main.r_user_id_prc = ec.plan_user_id  -- Ответственный сотрудник
                and trunc(ec.plan_dt) = trunc(sysdate)  -- Запланировано на сегодня
        )
        or
        not exists (
            select /*+index(ec)*/ null from events_calendar ec
            where ec.ext_id = d_main.ext_id
                and nvl(ec.block_flag, 0) = 0
                and d_main.r_user_id_prc = ec.plan_user_id
        )
    )  -- Сортировка для определения приоритета обработки: 
    order by 
    ps.dt asc,  -- Сначала ближайшие даты платежей
    nvl(p.person_gmt, 3) desc,  -- Учитываем часовой пояс для времени контакта
    -- Сумма долга в пересчете на валюту (крупные долги - выше приоритет)
    (d_main.basic_sum + d_main.exp_basic_sum + d_main.percent_sum +
     d_main.exp_percent_sum) * GetCursCB2(trunc(d_main.load_dt), d_main.currency) desc,
    d_main.id desc  -- Для однозначности при одинаковых приоритетах



